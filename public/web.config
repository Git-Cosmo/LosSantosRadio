<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>

    <!-- Force HTTPS & Remove trailing slash -->
    <rewrite>
      <rules>
        <rule name="Redirect to HTTPS" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
    <!-- Exclude local container IPs -->
    <add input="{REMOTE_ADDR}" pattern="^(127\.0\.0\.1|172\.17\.0\.\d+|172\.24\.0\.\d+)$" negate="true" />
    
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>
        <!-- Redirect /ads.txt -->
        <rule name="Ads Redirect" stopProcessing="true">
          <match url="^ads\.txt$" />
          <action type="Redirect" url="https://srv.adstxtmanager.com/19390/lossantosradio.com" redirectType="Permanent" />
        </rule>
        <rule name="Remove trailing slash" stopProcessing="true">
          <match url="^(.*)/$" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Redirect" redirectType="Permanent" url="{R:1}" />
        </rule>

        <!-- Ignore static files including .webp so they bypass Laravel -->
        <rule name="Ignore static files" stopProcessing="true">
          <match url=".*\.(jpg|jpeg|png|gif|webp|css|js|svg|woff|woff2|ttf|eot)$" ignoreCase="true" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>

        <!-- Main Laravel route -->
        <rule name="Laravel" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="index.php" appendQueryString="true" />
        </rule>

      </rules>
    </rewrite>

    <!-- Handlers -->
    <handlers>
      <add name="PHP_via_FastCGI" path="*.php" verb="*" modules="FastCgiModule" scriptProcessor="C:\php\php-cgi.exe" resourceType="Either" requireAccess="Script" />

    </handlers>

    <!-- Default document -->
    <defaultDocument>
      <files>
        <clear />
        <add value="index.php" />
      </files>
    </defaultDocument>

    <directoryBrowse enabled="false" />
    <httpErrors errorMode="Detailed" />
        <caching enabled="false" enableKernelCache="false">
            <profiles>
                <add extension=".gif" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
                <add extension=".png" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
                <add extension=".jpeg" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
                <add extension=".jpg" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
                <add extension=".webp" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
                <add extension=".js" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
                <add extension=".css" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
                <add extension=".html" policy="CacheUntilChange" kernelCachePolicy="CacheUntilChange" />
            </profiles>
        </caching>
        <staticContent>
            <clientCache cacheControlMode="DisableCache" />
        </staticContent>
    <security>
      <requestFiltering allowDoubleEscaping="true" />
    </security>
        <urlCompression doStaticCompression="false" doDynamicCompression="false" />

  </system.webServer>
</configuration>
